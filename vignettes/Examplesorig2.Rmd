---
title: "Examples"
author: "Philip I. Pavlik Jr."
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Examples}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include = TRUE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=7.5,
  fig.path = "vigfig-"
)
    library(LKT)
    library(data.table)
    library(ggplot2)
library(crayon)
library(pROC)
# precomptued as per https://ropensci.org/blog/2019/12/08/precompute-vignettes/
```


# Load data

Get the data free:

<a href="https://datashop.memphis.edu/DatasetInfo?datasetId=1465" class="uri">https://datashop.memphis.edu/DatasetInfo?datasetId=1465</a>

```{r, echo=TRUE}
    val<-largerawsample

    #clean it up
    val$KC..Default.<-val$Problem.Name
    # make it a datatable
    val= setDT(val)

    #make unstratified folds for crossvaldiations
    val$fold<-sample(1:5,length(val$Anon.Student.Id),replace=T)

    # get the times of each trial in seconds from 1970
    val$CF..Time.<-as.numeric(as.POSIXct(as.character(val$Time),format="%Y-%m-%d %H:%M:%S"))

    #make sure it is ordered in the way the code expects
    val<-val[order(val$Anon.Student.Id, val$CF..Time.),]

    #create a binary response column to predict and extract only data with a valid value
    val$CF..ansbin.<-ifelse(tolower(val$Outcome)=="correct",1,ifelse(tolower(val$Outcome)=="incorrect",0,-1))
    val<-val[val$CF..ansbin==0 | val$CF..ansbin.==1,]



    # create durations
    val$Duration..sec.<-(val$CF..End.Latency.+val$CF..Review.Latency.+500)/1000

    # this function needs times and durations but you don't need it if you don't want to model time effects
    val <- computeSpacingPredictors(val, "KC..Default.") #allows recency, spacing, forgetting features to run
    val <- computeSpacingPredictors(val, "KC..Cluster.") #allows recency, spacing, forgetting features to run
    val <- computeSpacingPredictors(val, "Anon.Student.Id") #allows recency, spacing, forgetting features to run
    
    val <- computeSpacingPredictors(val, "CF..Correct.Answer.") #allows recency, spacing, forgetting features to run
```

# Additive Factors Model (AFM) fixed effect version

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=FALSE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default."),
      features = c("intercept", "intercept", "lineafm"))
```
# example of LASSOLKT

```{r, echo=TRUE}
    modelob <- LASSOLKTModel(
      data = val, gridpars=(1:9)/10,
      allcomponents = c("Anon.Student.Id","KC..Default."),
      allfeatures = c("intercept", "lineafm$","linefail","recency"))


str(modelob)
```
# example for the nosolve parameter to make it return the model matrix

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=FALSE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default."),
      features = c("intercept", "intercept", "lineafm"),nosolve=TRUE)
```

# Performance Factors Analysis (PFA) fixed effect version

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "linesuc$","linefail$"))
    # have to have prior predictions in data to do the next model in and adaptive system
    #   this needs to be added to the data with a first model like this
    val$pred<-modelob$prediction
```

# PFA using difficulty sensitive predictors (composite model requiring pred from prior model)

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "linesuc$","linefail$"))
    # have to have prior predictions in data to do the next model in and adaptive system
    #   this needs to be added to the data wth a first moodel like this
    val$pred<-modelob$prediction

    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "diffcorComp","linefail"))
```

# Recent Performance Factors Analysis (RPFA)

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "propdec2","linefail"),
      fixedpars=c(.9))
```

# Recency tracing with logitdec

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "logitdec","recency"),
      fixedpars=c(.9,.5))
```

# Recency tracing with logitdec and transfer from cluster

```{r, echo=TRUE}

modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default.","KC..Cluster."),
      features = c("intercept", "intercept", "logitdec","recency","logitdec"),
      fixedpars=c(.9,.5,.5))
```

# Performance Prediction Equation (PPE)

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "ppe","logitdec"),
      fixedpars=c(0.3491901,0.2045801,1e-05,0.9734477,0.4443027))
```

# base4

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "base4","logitdec"),
      fixedpars=c(0.1890747,0.6309054,0.05471752,.5,0.2160748))
```

Using other features #See LKT paper #See computefeatures function in
the main R code for package
<a href="https://github.com/Optimal-Learning-Lab/LKT/blob/master/R/LKTfunctions.R" class="uri">https://github.com/Optimal-Learning-Lab/LKT/blob/master/R/LKTfunctions.R</a>


# Covariates

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default."),
      features = c("logitdec", "logitdec", "lineafm"),fixedpars=c(.9,.8),
      covariates = c(NA,NA,"Level..Unitname."))
```

# Individualized Additive Factors Model (iAFM) fixed effect version

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default.","KC..Default."),
      features = c("intercept", "intercept", "lineafm$","lineafm"),
      covariates = c(NA,NA,NA,"Anon.Student.Id"))
```

# Crossvalidation

```{r, echo=TRUE}
# make student stratified folds (for crossvalidation for unseen population)
    # unq = sample(unique(val$Anon.Student.Id))
    # sfold = rep(1:5,length.out=length(unq))
    # val$fold = rep(0,length(val[,1]))
    # for(i in 1:5){val$fold[which(val$Anon.Student.Id %in% unq[which(sfold==i)])]=i}

    #simple AFM minus student intercept
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("KC..Default.","KC..Default."),
      features = c("intercept", "lineafm"),
      cv = TRUE)
    mean(modelob$cv_res$mcfad)

    #complex AFM minus student intercept
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("KC..Default.","KC..Default."),
      features = c("intercept$", "lineafm$"),
      cv = TRUE)
    mean(modelob$cv_res$mcfad)
```

# Connectors

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      connectors = c("+","*"),
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default."),
      features = c("logitdec", "logitdec$", "lineafm$"),
      fixedpars = c(.9, .85) )
```

# AutoKC

```{r}

mnames<-c("IRT",
          "Faculty",
          "Log Full autoKC",
          "Log Simple PFA",
          "Log Full PFA",
          "Log Full PFA full autoKC additive",
          "Log Full PFA Faculty additive ",
          "Log Simple PFA Faculty interactive ",
          "Log Simple PFA full autoKC interactive",
          "Log Full PFA simple autoKC interactive",
          "Log Simple PFA simple autoKC interactive")
r2s<-data.frame(name=mnames,r2s=NA,cvr2s=NA)
compl<-list(c("Anon.Student.Id","KC..Default."),
            c("Anon.Student.Id","KC..Default.", "Anon.Student.Id", "Anon.Student.Id"),
            c("Anon.Student.Id","KC..Default.", "KC..Default.", "KC..Default."),
            c("Anon.Student.Id","KC..Default.", "KC..Default.", "KC..Default."),
            c("Anon.Student.Id","KC..Default.", "KC..Default.", "KC..Default."),
            c("Anon.Student.Id","KC..Default.", "KC..Default.", "KC..Default." ,"KC..Default." ,"KC..Default."),
            c("Anon.Student.Id","KC..Default.", "KC..Default.","Anon.Student.Id", "KC..Default."  ,"Anon.Student.Id"),
            c("Anon.Student.Id","KC..Default.", "KC..Default.","Anon.Student.Id", "KC..Default."  ,"Anon.Student.Id"),
            c("Anon.Student.Id","KC..Default.", "KC..Default.", "KC..Default." ,"KC..Default." ,"KC..Default."),
            c("Anon.Student.Id","KC..Default.", "KC..Default.", "KC..Default." ,"KC..Default." ,"KC..Default."),
            c("Anon.Student.Id","KC..Default.", "KC..Default.", "KC..Default." ,"KC..Default." ,"KC..Default."))
featl<-list(c("intercept","intercept"),
            c("intercept","intercept",  "logfail",  "logsuc"),
            c("intercept","intercept",  "logfail$",  "logsuc$"),
            c("intercept","intercept",  "logfail", "logsuc"),
            c("intercept","intercept",  "logfail$", "logsuc$"),
            c("intercept","intercept",  "logfail$", "logfail$", "logsuc$", "logsuc$"),
            c("intercept","intercept",  "logfail$", "logfail", "logsuc$", "logsuc"),
            c("intercept","intercept",  "logfail", "logfail", "logsuc", "logsuc"),
            c("intercept","intercept",  "logfail", "logfail$", "logsuc", "logsuc$"),
            c("intercept","intercept",  "logfail$", "logfail", "logsuc$", "logsuc"),
            c("intercept","intercept",  "logfail", "logfail", "logsuc", "logsuc"))
connl<-list(c("+"),
            c("+","+","+"),
            c("+","+","+"),
            c("+","+","+"),
            c("+","+","+"),
            c("+","+","+","+","+"),
            c("+","+","+","+","+"),
            c("+","+","*","+","*"),
            c("+","+","*","+","*"),
            c("+","+","*","+","*"),
            c("+","+","*","+","*"))
autol <- list(c(0,0),
              c(0,0,0,0),
              c(0,0,40,40),
              c(0,0,0,0),
              c(0,0,0,0),
              c(0,0,0,40,0,40),
              c(0,0,0,0,0,0),
              c(0,0,0,0,0,0),
              c(0,0,0,40,0,40),
              c(0,0,0,40,0,40),
              c(0,0,0,40,0,40))
for(i in 1:length(compl)){
  modelob <<- LKT(data = val,components = compl[[i]],features = featl[[i]],connectors = connl[[i]],autoKC = autol[[i]],
                  cv=TRUE,verbose = FALSE)
  cat(mnames[i]," R2cv =  ",mean(modelob$cv_res$mcfad))
  cat(" R2 =  ",modelob$r2,"\n")
  r2s$r2s[i]<-modelob$r2
  r2s$cvr2s[i]<-mean(modelob$cv_res$mcfad)
}

r2s$cvr2s<-r2s$cvr2s-min(r2s$cvr2s)
r2s$name <- factor(r2s$name,levels = rev(mnames))
plot<-ggplot(r2s,
             aes(name,cvr2s)) +
  geom_bar(stat = "identity") +xlab("Model Version") + ylab("McFadden's R-squared Gain")+
  coord_flip()+ theme(text = element_text(size = 12))
plot


mnames<-seq(2,71,10)
for (i in c(3,6)){
  r2s<-data.frame(name=mnames,r2s=NA,cvr2s=NA,r2sr=NA,cvr2sr=NA)
  j<-1
  for(k in mnames){
    j<-j+1
    modelob <- LKT(data = val,components = compl[[i]],features = featl[[i]],connectors = connl[[i]],autoKC = k*(autol[[i]]>0),
                   cv=TRUE,verbose = FALSE)
    cat(k," R2cv =  ",mean(modelob$cv_res$mcfad))
    cat(" R2 =  ",modelob$r2,"\n")

    r2s$r2s[j-1]<-modelob$r2
    r2s$cvr2s[j-1]<-mean(modelob$cv_res$mcfad)

        modelob <- LKT(data = val,components = compl[[i]],features = featl[[i]],connectors = connl[[i]],autoKC = k*(autol[[i]]>0),
                   cv=TRUE,verbose = FALSE, autoKCcont = rep("rand",length(featl[[i]])))
    cat(k," R2cv =  ",mean(modelob$cv_res$mcfad))
    cat(" R2 =  ",modelob$r2,"\n")

    r2s$r2sr[j-1]<-modelob$r2
    r2s$cvr2sr[j-1]<-mean(modelob$cv_res$mcfad)

  }

  r2s$name <- factor(r2s$name,levels = (mnames))
  plot<-ggplot(r2s, aes(name, group=1))+
    geom_line(aes(y = cvr2s)) +
  geom_line(aes(y = cvr2sr), linetype="twodash")+
    scale_x_discrete(breaks=seq(from = 2, to = 71, by = 5)) +xlab("autoKC Clusters") + ylab("McFadden's R-squared Gain")+ theme(text = element_text(size = 16)) +
      geom_point(aes(y = cvr2s))+
      geom_point(aes(y = cvr2sr))
  print(plot)
}
```

# Synthetic discrimination parameter testing

```{r}

mnames<-c("IRT",
          "IRT ad inter",
          "AFM",
          "IRT ad inter with AFM",
          "IRT ad")
r2s<-data.frame(name=mnames,r2s=NA,cvr2s=NA)
compl<-list(c("Anon.Student.Id","KC..Default."),
            c("Anon.Student.Id","KC..Default."),
            c("Anon.Student.Id","KC..Default.","KC..Default."),
            c("Anon.Student.Id","KC..Default.","KC..Default."),
            c("Anon.Student.Id","KC..Default."))
featl<-list(c("intercept","intercept"),
            c("logitdec","intercept"),
            c("logitdec","intercept","lineafm"),
            c("logitdec","intercept","lineafm$"),
            c("logitdec","intercept"))
connl<-list(c("+"),
            c("*"),
            c("+","+"),
            c("*","+"),
            c("+"))
for(i in 1:5){
  modelob <<- LKT(data = val,components = compl[[i]],features = featl[[i]],connectors = connl[[i]],fixedpars=c(.925),interc=TRUE,
                  cv=FALSE,verbose = FALSE)
  #cat(mnames[i]," R2cv =  ",mean(modelob$cv_res$mcfad))
  cat(" R2 =  ",modelob$r2,"\n")
  r2s$r2s[i]<-modelob$r2
  #r2s$cvr2s[i]<-mean(modelob$cv_res$mcfad)
}
```


#Credibility intervals

```{r}

components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default.")
features = c("intercept", "intercept", "linesuc$","linefail$")

# or

components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default.")
features = c("logit", "logit", "linesuc","linefail")
fixedpars = c(.03,.03)

mod1 = LKT(setDT(val),inter=TRUE,
           components,
           features,
           fixedpars = fixedpars,
           seedpars = c(NA),cv = TRUE)

n_students=400
n_boot = 100
system.time({
  boot_res = LKT_HDI(val,n_boot,n_students,components=components,features=features,fixedpars=fixedpars)
})


#Names of coefficients that are non-significant (interval includes zero)
zero_idx = which(boot_res$coef_hdi$includes_zero==TRUE)
boot_res$coef_hdi$coef_name[zero_idx]

if(!is.na(unique(boot_res$par_reps[,zero_idx[1]]))){
  hist(boot_res$par_reps[,zero_idx[1]],breaks=50,main=boot_res$coef_hdi$coef_name[zero_idx][1])

abline(v=boot_res$coef_hdi$lower[zero_idx[1]],col="darkblue",lwd=3)
abline(v=boot_res$coef_hdi$upper[zero_idx[1]],col="darkblue",lwd=3)
abline(v=mean(boot_res$par_reps[,zero_idx[1]]),lty=2,col="darkblue",lwd=3)
#Estimate from full fit to data
  abline(v=boot_res$mod_full$coefs[which(rownames(boot_res$mod_full$coefs)==colnames(boot_res$par_reps)[zero_idx[1]])],col="firebrick3",lwd=3)} else {print(boot_res$coef_hdi)}
```

# Recency tracing with RPFA propdec2 feature

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept","intercept",  "intercept", "propdec2","recency"),
      fixedpars=c(NA,NA),maxitv=5)
```

#brpropdec
```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,dualfit = TRUE,
      components = c("KC..Default.","Anon.Student.Id","KC..Default.","KC..Default."),
      features = c("baseratepropdec", "logitdec", "logitdec","recency"),fixedpars =c(0.988209,0.9690458,0.9004974,0.2603806))
print(modelob$coefs)
cat("\n")
```


# Simple Optimization

```{r, echo=TRUE}


    modelob <- LKT(
      data = val, interc=TRUE,dualfit = TRUE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default."),
      features = c("logitdec", "logitdec","recency"),seedpars =c(0.9673974,0.7943158,.27))
print(modelob$coefs)
cat("\n")


val$pred2<-modelob$prediction

tdata<-val[Level..Unitname.=="Posttest",]
tdata$index<-paste(tdata$Anon.Student.Id,tdata$KC..Default.)
tdata$tot<-countOutcome(tdata,tdata$index,"CORRECT")
tdata$tot<-tdata$tot+countOutcome(tdata,tdata$index,"INCORRECT")
plot(aggregate(CF..ansbin. ~tot , tdata , FUN= "mean" ),ylim=c(0,1))
points(aggregate(pred2 ~tot, tdata , FUN= "mean" ),ylim=c(0,1),col="red")


tdata<-val[Level..Unitname.!="Posttest",]
tdata$index<-paste(tdata$Anon.Student.Id,tdata$KC..Default.)
tdata$tot<-countOutcome(tdata,tdata$index,"CORRECT")
tdata$tot<-tdata$tot+countOutcome(tdata,tdata$index,"INCORRECT")
plot(aggregate(CF..ansbin. ~tot , tdata , FUN= "mean" ),ylim=c(0,1))
points(aggregate(pred2 ~tot, tdata , FUN= "mean" ),ylim=c(0,1),col="red")



```


#Build LKT with special feature
```{r, echo=TRUE}

q<-  buildLKTModel(data = val, interc=TRUE, specialcomponents = "CF..End.Latency.",specialfeatures = "numer",
      allcomponents = c("Anon.Student.Id", "KC..Default."),traceCV=TRUE,
      currentcomponents = c(),forv=100,bacv=80,
      allfeatures = c("lineafm","logafm","logsuc","logfail","linesuc","linefail","propdec","recencysuc","recencyfail"),
      currentfeatures = c( ),currentfixedpars = c(),forward=TRUE,backward=TRUE,
      maxitv=1,verbose=FALSE)
```


#Bidirectional BestLR features empty start
```{r, echo=TRUE, fig.height = 3, fig.width = 6}

q<-  stepLKT(data = val, interc=TRUE,
      allcomponents = c("Anon.Student.Id", "KC..Default.","CF..Correct.Answer."),forv=100,bacv=100,
      allfeatures = c("intercept","lineafm","logafm","logsuc","logfail","linesuc","linefail",
                      "lineafm$","logafm$","logsuc$","logfail$","linesuc$","linefail$"))
```


#Load MATHia
```{r, echo=TRUE}

datafile<-"C:/Users/ppavl/Dropbox/Active projects/ds4845_tx_All_Data_6977_2021_0723_141809.txt" # CHANGE THIS VALUE TO THE DataShop export file IN YOUR R WORKING DIRECTORY
val2<-read.delim(colClasses = c("Anon.Student.Id"="character"),datafile,sep="\t", header=TRUE,quote="")
val2=as.data.table(val2)
val2$CF..Time.<-as.numeric(as.POSIXct(as.character(val2$Time),format="%Y-%m-%d %H:%M:%S"))

    #make sure it is ordered in the way the code expects
    val2<-val2[order(val2$Anon.Student.Id, val2$CF..Time.),]

    #create a binary response column to predict and extract only data with a valid value
    
    val2$Outcome<-ifelse(tolower(val2$Outcome)=="ok","CORRECT","INCORRECT")
    val2$CF..ansbin.<-ifelse(tolower(val2$Outcome)=="correct",1,0)
    val2<-val2[val2$CF..ansbin==0 | val2$CF..ansbin.==1,]
    
#subtot<-  aggregate(val2$CF..ansbin.,by=list(val2$Anon.Student.Id),FUN=length)
 # subtot<- subtot[subtot$x<20,]
   # val2<-val2[!(val2$Anon.Student.Id %in% subtot$Group.1),]
    val2<-val2[val2$Attempt.At.Step==1,]
        val2<-val2[val2$KC..MATHia.!="",]
     val2 <- computeSpacingPredictors(val2, "KC..MATHia.") #allows recency, spacing, forgetting features to run
    val2 <- computeSpacingPredictors(val2, "Problem.Name") #allows recency, spacing, forgetting features to run
    val2 <- computeSpacingPredictors(val2, "Anon.Student.Id") #allows recency, spacing, forgetting features to run

    ```

#AFMstartMATHia
```{r, echo=TRUE}
AFMstartMATHia<-  buildLKTModel(data = val2, interc=TRUE,
      allcomponents = c("Anon.Student.Id", "KC..MATHia.","Problem.Name"),
      currentcomponents = c("Anon.Student.Id","KC..MATHia.","KC..MATHia."),
      forv=500,bacv=500,
      allfeatures = c("intercept","lineafm","logafm","logsuc","logfail",
                      "linesuc","linefail","logitdec","propdec","recency","logsuc$", "logfail$"),
      traceCV=FALSE,maxitv=8,
      currentfeatures = c("intercept", "intercept", "lineafm$"))
save(AFMstartMATHia,list="AFMstartMATHia",file="AFMstartMATHia")


```
```{r, echo=TRUE}
 modelob <- LKT(
      data = val2, interc=TRUE,
      components = c("KC..MATHia.", "KC..MATHia.", "KC..MATHia.", "Anon.Student.Id"),
      features = c("intercept", "recency", "logitdec", "logitdec" ),maxitv = 8,cv=FALSE,fixedpars = c(NA,NA,NA))
```

#BestLRstartMATHia
```{r, echo=TRUE}
BestLRstartMATHia<-  buildLKTModel(data = val2, interc=TRUE,
      allcomponents = c("Anon.Student.Id", "KC..MATHia.","Problem.Name"),
      currentcomponents = c("Anon.Student.Id","Problem.Name","Anon.Student.Id","Anon.Student.Id","KC..MATHia.","KC..MATHia.","KC..MATHia."),
      forv=500,bacv=500,
      allfeatures = c("intercept","lineafm","logafm","logsuc","logfail",
                      "linesuc","linefail","logitdec","propdec","recency","logsuc$", "logfail$"),
      traceCV=FALSE,maxitv=8,
      currentfeatures = c("intercept", "intercept", "logsuc", "logfail","intercept", 
                          "logsuc$", "logfail$"))

save(BestLRstartMATHia,list="BestLRstartMATHia",file="BestLRstartMATHia")

```
```{r, echo=TRUE}
 modelob <- LKT(
      data = val2, interc=TRUE,
      components = c("Problem.Name","Problem.Name", "KC..MATHia.", "KC..MATHia.", "Anon.Student.Id","Anon.Student.Id"),
      features = c("linesuc", "recency", "recency", "intercept", "logsuc","logfail" ),maxitv = 8,cv=FALSE,fixedpars = c(NA,NA))
```
#EmptystartMATHia
```{r, echo=TRUE}
EmptystartMATHia<-  buildLKTModel(data = val2, interc=TRUE,
      allcomponents = c("Anon.Student.Id", "KC..MATHia.","Problem.Name"),
      forv=500,bacv=500,
      allfeatures = c("intercept","lineafm","logafm","logsuc","logfail",
                      "linesuc","linefail","logitdec","propdec","recency","logsuc$", "logfail$"),
      traceCV=FALSE,maxitv=8)
save(EmptystartMATHia,list="EmptystartMATHia",file="EmptystartMATHia")
```






#AFMstartCloze
```{r, echo=TRUE}

AFMstartCloze<-  buildLKTModel(data = val, interc=TRUE,
      allcomponents = c("Anon.Student.Id", "KC..Default.","KC..Cluster.","CF..Correct.Answer."),
      currentcomponents = c("Anon.Student.Id","KC..Cluster.","KC..Cluster.","CF..Correct.Answer.","CF..Correct.Answer."),forv=500,bacv=500,
      
      allfeatures = c("intercept","lineafm","logafm","logsuc","logfail",
                      "linesuc","linefail","logitdec","propdec","recency","logsuc$", "logfail$"),traceCV=TRUE,maxitv=8,
      currentfeatures = c("intercept", "intercept",         "lineafm$", "intercept",         "lineafm$"),metric="BIC")
save(AFMstartCloze,list="AFMstartCloze",file="AFMstartCloze")

```


#BestLRstartCloze
```{r, echo=TRUE}
BestLRstartCloze<-  buildLKTModel(data = val, interc=TRUE,
      allcomponents = c("Anon.Student.Id", "KC..Default.","KC..Cluster.","CF..Correct.Answer."),
      currentcomponents = c("Anon.Student.Id","KC..Default.","Anon.Student.Id","Anon.Student.Id","KC..Cluster.","KC..Cluster.",
                            "KC..Cluster.","CF..Correct.Answer.","CF..Correct.Answer.","CF..Correct.Answer."),
      forv=500,bacv=500,
      allfeatures = c("intercept","lineafm","logafm","logsuc","logfail",
                      "linesuc","linefail","logitdec","propdec","recency","logsuc$", "logfail$"),
      traceCV=TRUE,maxitv=8,
     currentfeatures = c("intercept", "intercept", "logsuc", "logfail","intercept", "logsuc$",
                          "logfail$","intercept", "logsuc$", "logfail$"))
save(BestLRstartCloze,list="BestLRstartCloze",file="BestLRstartCloze")
```

#EmptystartCloze
```{r, echo=TRUE}
EmptystartCloze<-  buildLKTModel(data = val, interc=TRUE,
      allcomponents = c("Anon.Student.Id", "KC..Default.","KC..Cluster.","CF..Correct.Answer."),
      forv=500,bacv=500,
      allfeatures = c("intercept","lineafm","logafm","logsuc","logfail",
                      "linesuc","linefail","logitdec","propdec","recency","logsuc$", "logfail$"),
      traceCV=TRUE,maxitv=8)
save(EmptystartCloze,list="EmptystartCloze",file="EmptystartCloze")
```


#Table and figure
```{r, echo=TRUE, render=lemon_print}
load("AFMstartCloze")
tracetable<-AFMstartCloze[[1]]
rownames(tracetable) <- NULL
tracetable[,c(3,5,6,7,9)]<-round(tracetable[,c(3,5,6,7,9)],3)
print(tracetable[,c(3,5,6,7,9,10)],row.names=FALSE)
png(file="C:\\Users\\ppavl\\Dropbox\\Active projects\\AFMstartCloze.png",width=6.3,height=6.3,res=300, units="in")
par(mar=c(18, 5, 1, 1))
  matplot(cbind(-scale(tracetable$r2),scale(tracetable$BIC),-scale(tracetable$AUC),
                scale(tracetable$AIC),scale(tracetable$RMSE)), type="l", xaxt = "n",
          ylab = "Scaled Scores", lwd=2,cex=1.5)

  axis(1, at = 1:nrow(tracetable), labels = paste(tracetable$action), cex.axis = 1.2,las=2)
  legend("topright", c("R squared","BIC","AUC","AIC","RMSE"), col=1:5, cex=.8, lty=1:5, lwd=2)
  mtext(side=1, text="Step Actions", line=16)
  dev.off()
x<-AFMstartCloze
rm(AFMstartCloze)
cat(x[[1]]$BIC[1],
x[[1]]$BIC[length(x[[1]]$BIC)],
round(x[[1]]$AUC[1],3),
round(x[[1]]$AUC[length(x[[1]]$AUC)],3),
round(x[[1]]$AUC[length(x[[1]]$AUC)]-x[[1]]$AUC[1],3),
x[[1]]$params[length(x[[1]]$params)]-x[[1]]$params[1],sep="\t")

load("BestLRstartCloze")
tracetable<-BestLRstartCloze[[1]]
rownames(tracetable) <- NULL
tracetable[,c(3,5,6,7,9)]<-round(tracetable[,c(3,5,6,7,9)],3)
print(tracetable[,c(3,5,6,7,9,10)],row.names=FALSE)
png(file="C:\\Users\\ppavl\\Dropbox\\Active projects\\BestLRstartCloze.png",width=6.3,height=6.3,res=300, units="in")
par(mar=c(18, 5, 1, 1))
  matplot(cbind(-scale(tracetable$r2),scale(tracetable$BIC),-scale(tracetable$AUC),
                scale(tracetable$AIC),scale(tracetable$RMSE)), type="l", xaxt = "n",
          ylab = "Scaled Scores", lwd=2,cex=1.5)

  axis(1, at = 1:nrow(tracetable), labels = paste(tracetable$action), cex.axis = 1.2,las=2)
  legend("topright", c("R squared","BIC","AUC","AIC","RMSE"), col=1:5, cex=.8, lty=1:5, lwd=2)
  mtext(side=1, text="Step Actions", line=16)
  dev.off()
x<-BestLRstartCloze
rm(BestLRstartCloze)
cat(x[[1]]$BIC[1],
x[[1]]$BIC[length(x[[1]]$BIC)],
round(x[[1]]$AUC[1],3),
round(x[[1]]$AUC[length(x[[1]]$AUC)],3),
round(x[[1]]$AUC[length(x[[1]]$AUC)]-x[[1]]$AUC[1],3),
x[[1]]$params[length(x[[1]]$params)]-x[[1]]$params[1],sep="\t")

load("EmptystartCloze")
tracetable<-EmptystartCloze[[1]]
rownames(tracetable) <- NULL
tracetable[,c(3,5,6,7,9)]<-round(tracetable[,c(3,5,6,7,9)],3)
print(tracetable[,c(3,5,6,7,9,10)],row.names=FALSE)
png(file="C:\\Users\\ppavl\\Dropbox\\Active projects\\EmptystartCloze.png",width=6.3,height=6.3,res=300, units="in")
par(mar=c(18, 5, 1, 1))
  matplot(cbind(-scale(tracetable$r2),scale(tracetable$BIC),-scale(tracetable$AUC),
                scale(tracetable$AIC),scale(tracetable$RMSE)), type="l", xaxt = "n",
          ylab = "Scaled Scores", lwd=2,cex=1.5)

  axis(1, at = 1:nrow(tracetable), labels = paste(tracetable$action), cex.axis = 1.2,las=2)
  legend("topright", c("R squared","BIC","AUC","AIC","RMSE"), col=1:5, cex=.8, lty=1:5, lwd=2)
  mtext(side=1, text="Step Actions", line=16)
  dev.off()
x<-EmptystartCloze
rm(EmptystartCloze)
cat(x[[1]]$BIC[1],
x[[1]]$BIC[length(x[[1]]$BIC)],
round(x[[1]]$AUC[1],3),
round(x[[1]]$AUC[length(x[[1]]$AUC)],3),
round(x[[1]]$AUC[length(x[[1]]$AUC)]-x[[1]]$AUC[1],3),
x[[1]]$params[length(x[[1]]$params)]-x[[1]]$params[1],sep="\t")

load("AFMstartMATHia")
tracetable<-AFMstartMATHia[[1]]
rownames(tracetable) <- NULL
tracetable[,c(3,5,6,7,9)]<-round(tracetable[,c(3,5,6,7,9)],3)
print(tracetable[,c(3,5,6,7,9,10)],row.names=FALSE)
png(file="C:\\Users\\ppavl\\Dropbox\\Active projects\\AFMstartMATHia.png",width=6.3,height=6.3,res=300, units="in")
par(mar=c(18, 5, 1, 1))
  matplot(cbind(-scale(tracetable$r2),scale(tracetable$BIC),-scale(tracetable$AUC),
                scale(tracetable$AIC),scale(tracetable$RMSE)), type="l", xaxt = "n",
          ylab = "Scaled Scores", lwd=2,cex=1.5)

  axis(1, at = 1:nrow(tracetable), labels = paste(tracetable$action), cex.axis = 1.2,las=2)
  legend("topright", c("R squared","BIC","AUC","AIC","RMSE"), col=1:5, cex=.8, lty=1:5, lwd=2)
  mtext(side=1, text="Step Actions", line=16)
  dev.off()
x<-AFMstartMATHia
rm(AFMstartMATHia)
cat(x[[1]]$BIC[1],
x[[1]]$BIC[length(x[[1]]$BIC)],
round(x[[1]]$AUC[1],3),
round(x[[1]]$AUC[length(x[[1]]$AUC)],3),
round(x[[1]]$AUC[length(x[[1]]$AUC)]-x[[1]]$AUC[1],3),
x[[1]]$params[length(x[[1]]$params)]-x[[1]]$params[1],sep="\t")

load("BestLRstartMATHia")
tracetable<-BestLRstartMATHia[[1]]
rownames(tracetable) <- NULL
tracetable[,c(3,5,6,7,9)]<-round(tracetable[,c(3,5,6,7,9)],3)
print(tracetable[,c(3,5,6,7,9,10)],row.names=FALSE)
png(file="C:\\Users\\ppavl\\Dropbox\\Active projects\\BestLRstartMATHia.png",width=6.3,height=6.3,res=300, units="in")
par(mar=c(18, 5, 1, 1))
  matplot(cbind(-scale(tracetable$r2),scale(tracetable$BIC),-scale(tracetable$AUC),
                scale(tracetable$AIC),scale(tracetable$RMSE)), type="l", xaxt = "n",
          ylab = "Scaled Scores", lwd=2,cex=1.5)

  axis(1, at = 1:nrow(tracetable), labels = paste(tracetable$action), cex.axis = 1.2,las=2)
  legend("topright", c("R squared","BIC","AUC","AIC","RMSE"), col=1:5, cex=.8, lty=1:5, lwd=2)
  mtext(side=1, text="Step Actions", line=16)
  dev.off()
x<-BestLRstartMATHia
rm(BestLRstartMATHia)
cat(x[[1]]$BIC[1],
x[[1]]$BIC[length(x[[1]]$BIC)],
round(x[[1]]$AUC[1],3),
round(x[[1]]$AUC[length(x[[1]]$AUC)],3),
round(x[[1]]$AUC[length(x[[1]]$AUC)]-x[[1]]$AUC[1],3),
x[[1]]$params[length(x[[1]]$params)]-x[[1]]$params[1],sep="\t")

load("EmptystartMATHia")
tracetable<-EmptystartMATHia[[1]]
rownames(tracetable) <- NULL
tracetable[,c(3,5,6,7,9)]<-round(tracetable[,c(3,5,6,7,9)],3)
print(tracetable[,c(3,5,6,7,9,10)],row.names=FALSE)
png(file="C:\\Users\\ppavl\\Dropbox\\Active projects\\EmptystartMATHia.png",width=6.3,height=6.3,res=300, units="in")
par(mar=c(18, 5, 1, 1))
  matplot(cbind(-scale(tracetable$r2),scale(tracetable$BIC),-scale(tracetable$AUC),
                scale(tracetable$AIC),scale(tracetable$RMSE)), type="l", xaxt = "n",
          ylab = "Scaled Scores", lwd=2,cex=1.5)

  axis(1, at = 1:nrow(tracetable), labels = paste(tracetable$action), cex.axis = 1.2,las=2)
  legend("topright", c("R squared","BIC","AUC","AIC","RMSE"), col=1:5, cex=.8, lty=1:5, lwd=2)
  mtext(side=1, text="Step Actions", line=16)
  dev.off()
x<-EmptystartMATHia
rm(EmptystartMATHia)
cat(x[[1]]$BIC[1],
x[[1]]$BIC[length(x[[1]]$BIC)],
round(x[[1]]$AUC[1],3),
round(x[[1]]$AUC[length(x[[1]]$AUC)],3),
round(x[[1]]$AUC[length(x[[1]]$AUC)]-x[[1]]$AUC[1],3),
x[[1]]$params[length(x[[1]]$params)]-x[[1]]$params[1],sep="\t")

```



```{r, echo=TRUE}
 modelob <- LKT(
      data = val, interc=TRUE,
      components = c("CF..Correct.Answer.", "KC..Default.", "KC..Default.", "Anon.Student.Id", "KC..Cluster.", "Anon.Student.Id"),
      features = c("logsuc$", "recency", "intercept", "propdec", "recency", "linefail" ),maxitv = 4,cv=TRUE,fixedpars = c(NA,NA,NA))
```

#Graph
```{r, echo=TRUE}

tracetable<-BestLRstartMATHia[[1]]
png(file="C:\\Users\\ppavl\\Dropbox\\Active projects\\BestLRstartMATHia.png",width=6.3,height=6.3,res=300, units="in")
par(mar=c(16, 5, 1, 1))
  matplot(cbind(-scale(tracetable$r2),scale(tracetable$BIC),-scale(tracetable$AUC),
                scale(tracetable$AIC),scale(tracetable$RMSE)), type="l", xaxt = "n",
          ylab = "Scaled Scores", lwd=2,cex=1.5)

  axis(1, at = 1:nrow(tracetable), labels = paste(tracetable$action), cex.axis = 1,las=2)
  legend("topright", c("R squared","BIC","AUC","AIC","RMSE"), col=1:5, cex=.8, lty=1:5, lwd=2)
  mtext(side=1, text="Step Actions", line=14)
  dev.off()
```








```{r, echo=TRUE}



q<-  buildLKTModel(data = dat, interc=TRUE,
      allcomponents = c("Category"),
      currentcomponents = c("Category","Category","Problem.Name","Problem.Name","Anon.Student.Id"),forv=.001,bacv=.001,
      allfeatures = c("ppe"),currentfixedpars=c(0.4617277, 0.922732, 0.3778021, 0.7284311, 0.8526322),      currentfeatures = c("recency","logitdec","recency","logitdec","logitdec"),traceCV=FALSE,verbose=F,maxitv=7,metric="R2",backward = F)

modelob<-q[[2]]
dat$pred1<-modelob$prediction
mdata1<-mdatax(dat,pred1)
mdata11<-mdata1[17:24,]
cor(mdata1$mean,emdata$mean)
emplot(emdata1,mdata11,"PFA-Categorization")  #the plot of posttest
emplot(emdata,mdata1,"PFA-Categorization")      #the plot of all the sessions
q[[2]]$coefs
```
