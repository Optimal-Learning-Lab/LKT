---
title: "Examples"
author: "Philip I. Pavlik Jr."
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Examples}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include = TRUE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=7.5,
  fig.path = "vigfig-"
)
    library(LKT)
    library(data.table)
    library(ggplot2)
# precomptued as per https://ropensci.org/blog/2019/12/08/precompute-vignettes/
```


# Load data

Get the data free:

<a href="https://datashop.memphis.edu/DatasetInfo?datasetId=1465" class="uri">https://datashop.memphis.edu/DatasetInfo?datasetId=1465</a>

```{r, echo=TRUE}
    val<-largerawsample

    #clean it up
    val$KC..Default.<-val$Problem.Name
    # make it a datatable
    val= setDT(val)

    #make unstratified folds for crossvaldiations
    val$fold<-sample(1:5,length(val$Anon.Student.Id),replace=T)

    # get the times of each trial in seconds from 1970
    val$CF..Time.<-as.numeric(as.POSIXct(as.character(val$Time),format="%Y-%m-%d %H:%M:%S"))

    #make sure it is ordered in the way the code expects
    val<-val[order(val$Anon.Student.Id, val$CF..Time.),]

    #create a binary response column to predict and extract only data with a valid value
    val$CF..ansbin.<-ifelse(tolower(val$Outcome)=="correct",1,ifelse(tolower(val$Outcome)=="incorrect",0,-1))
    val<-val[val$CF..ansbin==0 | val$CF..ansbin.==1,]



    # create durations
    val$Duration..sec.<-(val$CF..End.Latency.+val$CF..Review.Latency.+500)/1000

    # this function needs times and durations but you don't need it if you don't want to model time effects
    val <- computeSpacingPredictors(val, "KC..Default.") #allows recency, spacing, forgetting features to run
    val <- computeSpacingPredictors(val, "KC..Cluster.") #allows recency, spacing, forgetting features to run
    val <- computeSpacingPredictors(val, "Anon.Student.Id") #allows recency, spacing, forgetting features to run
    
    val <- computeSpacingPredictors(val, "CF..Correct.Answer.") #allows recency, spacing, forgetting features to run
```

# Additive Factors Model (AFM) fixed effect version

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=FALSE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default."),
      features = c("intercept", "intercept", "lineafm"))
```

# Performance Factors Analysis (PFA) fixed effect version

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "linesuc$","linefail$"))
    # have to have prior predictions in data to do the next model in and adaptive system
    #   this needs to be added to the data with a first model like this
    val$pred<-modelob$prediction
```

# PFA using difficulty sensitive predictors (composite model requiring pred from prior model)

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "linesuc$","linefail$"))
    # have to have prior predictions in data to do the next model in and adaptive system
    #   this needs to be added to the data wth a first moodel like this
    val$pred<-modelob$prediction

    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "diffcorComp","linefail"))
```

# Recent Performance Factors Analysis (RPFA)

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "propdec2","linefail"),
      fixedpars=c(.9))
```

# Recency tracing with logitdec

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "logitdec","recency"),
      fixedpars=c(.9,.5))
```

# Recency tracing with logitdec and transfer from cluster

```{r, echo=TRUE}

modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default.","KC..Cluster."),
      features = c("intercept", "intercept", "logitdec","recency","logitdec"),
      fixedpars=c(.9,.5,.5))
```

# Performance Prediction Equation (PPE)

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "ppe","logitdec"),
      seedpars=c(0.3491901,0.2045801,1e-05,0.9734477,0.4443027))
```

# base4

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "base4","logitdec"),
      fixedpars=c(0.1890747,0.6309054,0.05471752,.5,0.2160748))
```

Using other features #See LKT paper #See computefeatures function in
the main R code for package
<a href="https://github.com/Optimal-Learning-Lab/LKT/blob/master/R/LKTfunctions.R" class="uri">https://github.com/Optimal-Learning-Lab/LKT/blob/master/R/LKTfunctions.R</a>


# Covariates

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default."),
      features = c("logitdec", "logitdec", "lineafm"),fixedpars=c(.9,.8),
      covariates = c(NA,NA,"Level..Unitname."))
```

# Individualized Additive Factors Model (iAFM) fixed effect version

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default.","KC..Default."),
      features = c("intercept", "intercept", "lineafm$","lineafm"),
      covariates = c(NA,NA,NA,"Anon.Student.Id"))
```

# Crossvalidation

```{r, echo=TRUE}
# make student stratified folds (for crossvalidation for unseen population)
    # unq = sample(unique(val$Anon.Student.Id))
    # sfold = rep(1:5,length.out=length(unq))
    # val$fold = rep(0,length(val[,1]))
    # for(i in 1:5){val$fold[which(val$Anon.Student.Id %in% unq[which(sfold==i)])]=i}

    #simple AFM minus student intercept
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("KC..Default.","KC..Default."),
      features = c("intercept", "lineafm"),
      cv = TRUE)
    mean(modelob$cv_res$mcfad)

    #complex AFM minus student intercept
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("KC..Default.","KC..Default."),
      features = c("intercept$", "lineafm$"),
      cv = TRUE)
    mean(modelob$cv_res$mcfad)
```

# Connectors

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      connectors = c("+","*"),
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default."),
      features = c("logitdec", "logitdec$", "lineafm$"),
      fixedpars = c(.9, .85) )
```

# AutoKC

```{r}

mnames<-c("IRT",
          "Faculty",
          "Log Full autoKC",
          "Log Simple PFA",
          "Log Full PFA",
          "Log Full PFA full autoKC additive",
          "Log Full PFA Faculty additive ",
          "Log Simple PFA Faculty interactive ",
          "Log Simple PFA full autoKC interactive",
          "Log Full PFA simple autoKC interactive",
          "Log Simple PFA simple autoKC interactive")
r2s<-data.frame(name=mnames,r2s=NA,cvr2s=NA)
compl<-list(c("Anon.Student.Id","KC..Default."),
            c("Anon.Student.Id","KC..Default.", "Anon.Student.Id", "Anon.Student.Id"),
            c("Anon.Student.Id","KC..Default.", "KC..Default.", "KC..Default."),
            c("Anon.Student.Id","KC..Default.", "KC..Default.", "KC..Default."),
            c("Anon.Student.Id","KC..Default.", "KC..Default.", "KC..Default."),
            c("Anon.Student.Id","KC..Default.", "KC..Default.", "KC..Default." ,"KC..Default." ,"KC..Default."),
            c("Anon.Student.Id","KC..Default.", "KC..Default.","Anon.Student.Id", "KC..Default."  ,"Anon.Student.Id"),
            c("Anon.Student.Id","KC..Default.", "KC..Default.","Anon.Student.Id", "KC..Default."  ,"Anon.Student.Id"),
            c("Anon.Student.Id","KC..Default.", "KC..Default.", "KC..Default." ,"KC..Default." ,"KC..Default."),
            c("Anon.Student.Id","KC..Default.", "KC..Default.", "KC..Default." ,"KC..Default." ,"KC..Default."),
            c("Anon.Student.Id","KC..Default.", "KC..Default.", "KC..Default." ,"KC..Default." ,"KC..Default."))
featl<-list(c("intercept","intercept"),
            c("intercept","intercept",  "logfail",  "logsuc"),
            c("intercept","intercept",  "logfail$",  "logsuc$"),
            c("intercept","intercept",  "logfail", "logsuc"),
            c("intercept","intercept",  "logfail$", "logsuc$"),
            c("intercept","intercept",  "logfail$", "logfail$", "logsuc$", "logsuc$"),
            c("intercept","intercept",  "logfail$", "logfail", "logsuc$", "logsuc"),
            c("intercept","intercept",  "logfail", "logfail", "logsuc", "logsuc"),
            c("intercept","intercept",  "logfail", "logfail$", "logsuc", "logsuc$"),
            c("intercept","intercept",  "logfail$", "logfail", "logsuc$", "logsuc"),
            c("intercept","intercept",  "logfail", "logfail", "logsuc", "logsuc"))
connl<-list(c("+"),
            c("+","+","+"),
            c("+","+","+"),
            c("+","+","+"),
            c("+","+","+"),
            c("+","+","+","+","+"),
            c("+","+","+","+","+"),
            c("+","+","*","+","*"),
            c("+","+","*","+","*"),
            c("+","+","*","+","*"),
            c("+","+","*","+","*"))
autol <- list(c(0,0),
              c(0,0,0,0),
              c(0,0,40,40),
              c(0,0,0,0),
              c(0,0,0,0),
              c(0,0,0,40,0,40),
              c(0,0,0,0,0,0),
              c(0,0,0,0,0,0),
              c(0,0,0,40,0,40),
              c(0,0,0,40,0,40),
              c(0,0,0,40,0,40))
for(i in 1:length(compl)){
  modelob <<- LKT(data = val,components = compl[[i]],features = featl[[i]],connectors = connl[[i]],autoKC = autol[[i]],
                  cv=TRUE,verbose = FALSE)
  cat(mnames[i]," R2cv =  ",mean(modelob$cv_res$mcfad))
  cat(" R2 =  ",modelob$r2,"\n")
  r2s$r2s[i]<-modelob$r2
  r2s$cvr2s[i]<-mean(modelob$cv_res$mcfad)
}

r2s$cvr2s<-r2s$cvr2s-min(r2s$cvr2s)
r2s$name <- factor(r2s$name,levels = rev(mnames))
plot<-ggplot(r2s,
             aes(name,cvr2s)) +
  geom_bar(stat = "identity") +xlab("Model Version") + ylab("McFadden's R-squared Gain")+
  coord_flip()+ theme(text = element_text(size = 12))
plot


mnames<-seq(2,71,10)
for (i in c(3,6)){
  r2s<-data.frame(name=mnames,r2s=NA,cvr2s=NA,r2sr=NA,cvr2sr=NA)
  j<-1
  for(k in mnames){
    j<-j+1
    modelob <- LKT(data = val,components = compl[[i]],features = featl[[i]],connectors = connl[[i]],autoKC = k*(autol[[i]]>0),
                   cv=TRUE,verbose = FALSE)
    cat(k," R2cv =  ",mean(modelob$cv_res$mcfad))
    cat(" R2 =  ",modelob$r2,"\n")

    r2s$r2s[j-1]<-modelob$r2
    r2s$cvr2s[j-1]<-mean(modelob$cv_res$mcfad)

        modelob <- LKT(data = val,components = compl[[i]],features = featl[[i]],connectors = connl[[i]],autoKC = k*(autol[[i]]>0),
                   cv=TRUE,verbose = FALSE, autoKCcont = rep("rand",length(featl[[i]])))
    cat(k," R2cv =  ",mean(modelob$cv_res$mcfad))
    cat(" R2 =  ",modelob$r2,"\n")

    r2s$r2sr[j-1]<-modelob$r2
    r2s$cvr2sr[j-1]<-mean(modelob$cv_res$mcfad)

  }

  r2s$name <- factor(r2s$name,levels = (mnames))
  plot<-ggplot(r2s, aes(name, group=1))+
    geom_line(aes(y = cvr2s)) +
  geom_line(aes(y = cvr2sr), linetype="twodash")+
    scale_x_discrete(breaks=seq(from = 2, to = 71, by = 5)) +xlab("autoKC Clusters") + ylab("McFadden's R-squared Gain")+ theme(text = element_text(size = 16)) +
      geom_point(aes(y = cvr2s))+
      geom_point(aes(y = cvr2sr))
  print(plot)
}
```

# Synthetic discrimination parameter testing

```{r}

mnames<-c("IRT",
          "IRT ad inter",
          "AFM",
          "IRT ad inter with AFM",
          "IRT ad")
r2s<-data.frame(name=mnames,r2s=NA,cvr2s=NA)
compl<-list(c("Anon.Student.Id","KC..Default."),
            c("Anon.Student.Id","KC..Default."),
            c("Anon.Student.Id","KC..Default.","KC..Default."),
            c("Anon.Student.Id","KC..Default.","KC..Default."),
            c("Anon.Student.Id","KC..Default."))
featl<-list(c("intercept","intercept"),
            c("logitdec","intercept"),
            c("logitdec","intercept","lineafm"),
            c("logitdec","intercept","lineafm$"),
            c("logitdec","intercept"))
connl<-list(c("+"),
            c("*"),
            c("+","+"),
            c("*","+"),
            c("+"))
for(i in 1:5){
  modelob <<- LKT(data = val,components = compl[[i]],features = featl[[i]],connectors = connl[[i]],fixedpars=c(.925),interc=TRUE,
                  cv=FALSE,verbose = FALSE)
  #cat(mnames[i]," R2cv =  ",mean(modelob$cv_res$mcfad))
  cat(" R2 =  ",modelob$r2,"\n")
  r2s$r2s[i]<-modelob$r2
  #r2s$cvr2s[i]<-mean(modelob$cv_res$mcfad)
}
```


#Credibility intervals

```{r}

components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default.")
features = c("intercept", "intercept", "linesuc$","linefail$")

# or

components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default.")
features = c("logit", "logit", "linesuc","linefail")
fixedpars = c(.03,.03)

mod1 = LKT(setDT(val),inter=TRUE,
           components,
           features,
           fixedpars = fixedpars,
           seedpars = c(NA),cv = TRUE)

n_students=400
n_boot = 100
system.time({
  boot_res = LKT_HDI(val,n_boot,n_students,components=components,features=features,fixedpars=fixedpars)
})


#Names of coefficients that are non-significant (interval includes zero)
zero_idx = which(boot_res$coef_hdi$includes_zero==TRUE)
boot_res$coef_hdi$coef_name[zero_idx]

if(!is.na(unique(boot_res$par_reps[,zero_idx[1]]))){
  hist(boot_res$par_reps[,zero_idx[1]],breaks=50,main=boot_res$coef_hdi$coef_name[zero_idx][1])

abline(v=boot_res$coef_hdi$lower[zero_idx[1]],col="darkblue",lwd=3)
abline(v=boot_res$coef_hdi$upper[zero_idx[1]],col="darkblue",lwd=3)
abline(v=mean(boot_res$par_reps[,zero_idx[1]]),lty=2,col="darkblue",lwd=3)
#Estimate from full fit to data
  abline(v=boot_res$mod_full$coefs[which(rownames(boot_res$mod_full$coefs)==colnames(boot_res$par_reps)[zero_idx[1]])],col="firebrick3",lwd=3)} else {print(boot_res$coef_hdi)}
```

# Recency tracing with RPFA propdec2 feature

```{r, echo=TRUE}
    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id", "KC..Default.", "KC..Default.", "KC..Default."),
      features = c("intercept", "intercept", "propdec2","recency"),
      fixedpars=c(NA,NA),maxitv=5)
```



# Adaptive Knowledge Tracing

```{r, echo=TRUE}
 modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default.","KC..Default.","KC..Default."),
      features = c("intercept","intercept", "linesuc", "linefail","recency"),fixedpars =c(0.2843158))
print(modelob$coefs)
cat("\n")

    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default.","KC..Default."),
      features = c("logitdec", "linesuc", "linefail","recency"),fixedpars =c(0.9673974,0.2843158))
print(modelob$coefs)
cat("\n")

modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default.","KC..Default.","KC..Default."),
      features = c("logitdec","intercept","linesuc", "linefail","recency"),fixedpars =c(0.9673974,0.44))
print(modelob$coefs)
cat("\n")


    modelob <- LKT(
      data = val, interc=TRUE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default."),
      features = c("logitdec","linesuc","recency"),fixedpars =c(0.9673974,0.47))
print(modelob$coefs)
val$pred<-modelob$prediction
cat("\n")

    modelob <- LKT(
      data = val, interc=TRUE,dualfit=TRUE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default."),
      features = c("logitdec","diffcorComp","recency"),fixedpars =c(0.9642107,0.4797579))
print(modelob$coefs)
cat("\n")

    modelob <- LKT(
      data = val, interc=TRUE, dualfit=TRUE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default.","KC..Default."),
      features = c("logitdec","diffcorComp","recencysuc","recencyfail"),fixedpars =c(0.9682298,0.1870481,0.5788126))
print(modelob$coefs)
cat("\n")

    modelob <- LKT(
      data = val, interc=TRUE, dualfit=TRUE,
      components = c("Anon.Student.Id","KC..Default.","KC..Default.","KC..Default.","KC..Default."),
      features = c("logitdec","diffcor1","diffcor2","recencysuc","recencyfail"),fixedpars =c(0.967,0.184,0.579))
print(modelob$coefs)
cat("\n")

val$pred2<-modelob$prediction

tdata<-val[Level..Unitname.=="Posttest",]
tdata$index<-paste(tdata$Anon.Student.Id,tdata$KC..Default.)
tdata$tot<-countOutcome(tdata,tdata$index,"CORRECT")
tdata$tot<-tdata$tot+countOutcome(tdata,tdata$index,"INCORRECT")
plot(aggregate(CF..ansbin. ~tot , tdata , FUN= "mean" ),ylim=c(0,1))
points(aggregate(pred2 ~tot, tdata , FUN= "mean" ),ylim=c(0,1),col="red")


tdata<-val[Level..Unitname.!="Posttest",]
tdata$index<-paste(tdata$Anon.Student.Id,tdata$KC..Default.)
tdata$tot<-countOutcome(tdata,tdata$index,"CORRECT")
tdata$tot<-tdata$tot+countOutcome(tdata,tdata$index,"INCORRECT")
plot(aggregate(CF..ansbin. ~tot , tdata , FUN= "mean" ),ylim=c(0,1))
points(aggregate(pred2 ~tot, tdata , FUN= "mean" ),ylim=c(0,1),col="red")




pv <- 1:100 / 100
fixedcost <- 26.5
scal <- .792
const <- 6.4

F6 <- -1.44
F5 <- 1.48
gains = pv * (F5 * pv + F6 * pv ^ 2) + (1 - pv) * 0


plot(
  pv,
  gains ,
  type = "n",
  xlab = "Difficulty of practice trial",
  ylab = "Logit gain from trial",
  main = "Cloze Difficulty Effect"
)
lines(pv, gains, lwd = 3, col = "red")

plot(
  pv,
  gains / (pv * (const + scal * exp(-qlogis(
    pv
  ))) + (1 - pv) * (fixedcost)),
  type = "n",  xlab = "Difficulty of practice trial (probabilty of success)",
  ylab = "Logit gain per second of practice"
)#     main="Cloze Efficiency")
lines(pv, gains / (pv * (const + scal * exp(-qlogis(pv))) +
                     (1 - pv) * (fixedcost)), lwd = 3, col = "red")



pv[which((gains / (
  pv * (const + scal * exp(-qlogis(pv))) + (1 - pv) * (fixedcost)
)) ==
  max((gains / (
    pv * (const + scal * exp(-qlogis(pv))) + (1 - pv) * (fixedcost)
  ))))]


```


#Build LKT with special feature
```{r, echo=TRUE}

q<-  buildLKTModel(data = val, interc=TRUE, specialcomponents = "CF..End.Latency.",specialfeatures = "numer",
      allcomponents = c("Anon.Student.Id", "KC..Default."),traceCV=TRUE,
      currentcomponents = c(),its=4,forv=100,bacv=80,
      allfeatures = c("lineafm","logafm","logsuc","logfail","linesuc","linefail","propdec","recencysuc","recencyfail"),
      currentfeatures = c( ),currentfixedpars = c(),forward=TRUE,backward=TRUE,
      maxitv=1,verbose=FALSE)
```





#Bidirectional BestLR features empty start
```{r, echo=TRUE, fig.height = 3, fig.width = 6}

q<-  stepLKT(data = val, interc=TRUE,
      allcomponents = c("Anon.Student.Id", "KC..Default.","CF..Correct.Answer."),forv=100,bacv=100,
      allfeatures = c("intercept","lineafm","logafm","logsuc","logfail","linesuc","linefail",
                      "lineafm$","logafm$","logsuc$","logfail$","linesuc$","linefail$"))
```

#Bidirectional BestLR features enhanced with full start
```{r, echo=TRUE}

q<-  stepLKT(data = val, interc=TRUE,
      allcomponents = c("Anon.Student.Id", "KC..Default.","KC..Cluster.","CF..Correct.Answer."),
      currentcomponents = c("Anon.Student.Id","KC..Default.","Anon.Student.Id","Anon.Student.Id","KC..Cluster.",
                            "KC..Cluster.","KC..Cluster.","CF..Correct.Answer.","CF..Correct.Answer.","CF..Correct.Answer."),
      forv=.008,bacv=.006,
      allfeatures = c("lineafm","logafm","logsuc","logfail",
                      "linesuc","linefail","propdec","recency","recencysuc","recencyfail"),
      traceCV=FALSE,
      currentfeatures = c("intercept", "intercept", "linesuc", "linefail","intercept", 
                          "logsuc$", "logfail$","intercept", "logsuc$", "logfail$"),metric="R2",)
```

#Bidirectional BestLR features enhanced with full start
```{r, echo=TRUE}
datafile<-"C:/Users/ppavl/Dropbox/Active projects/ds4845_tx_All_Data_6977_2021_0723_141809.txt" # CHANGE THIS VALUE TO THE DataShop export file IN YOUR R WORKING DIRECTORY
val2<-read.delim(colClasses = c("Anon.Student.Id"="character"),datafile,sep="\t", header=TRUE,quote="")
val2=as.data.table(val2)
val2$CF..Time.<-as.numeric(as.POSIXct(as.character(val2$Time),format="%Y-%m-%d %H:%M:%S"))

    #make sure it is ordered in the way the code expects
    val2<-val2[order(val2$Anon.Student.Id, val2$CF..Time.),]

    #create a binary response column to predict and extract only data with a valid value
    
    val2$Outcome<-ifelse(tolower(val2$Outcome)=="ok","CORRECT","INCORRECT")
    val2$CF..ansbin.<-ifelse(tolower(val2$Outcome)=="correct",1,0)
    val2<-val2[val2$CF..ansbin==0 | val2$CF..ansbin.==1,]
    
#subtot<-  aggregate(val2$CF..ansbin.,by=list(val2$Anon.Student.Id),FUN=length)
 # subtot<- subtot[subtot$x<20,]
   # val2<-val2[!(val2$Anon.Student.Id %in% subtot$Group.1),]
    val2<-val2[val2$Attempt.At.Step==1,]
     val2 <- computeSpacingPredictors(val2, "KC..MATHia.") #allows recency, spacing, forgetting features to run
    val2 <- computeSpacingPredictors(val2, "Problem.Name") #allows recency, spacing, forgetting features to run
    val2 <- computeSpacingPredictors(val2, "Anon.Student.Id") #allows recency, spacing, forgetting features to run
    val2<-val2[val2$KC..MATHia.!="",]
        
q<-  buildLKTModel(data = val2, interc=TRUE,
      allcomponents = c("Anon.Student.Id", "KC..MATHia.","Problem.Name"),
      currentcomponents = c("Anon.Student.Id","KC..MATHia.","KC..MATHia."),
      forv=500,bacv=500,
      allfeatures = c("lineafm","logafm","logsuc","logfail",
                      "linesuc","linefail","logitdec","propdec","recency","expdecafm","logsuc$", "logfail$"),
      traceCV=FALSE,
      currentfeatures = c("intercept", "intercept",         "lineafm$"),lassodata=TRUE)
lasso(q)
q2<-  buildLKTModel(data = val2, interc=TRUE,
      allcomponents = c("Anon.Student.Id", "KC..MATHia.","Problem.Name"),
      currentcomponents = c("Anon.Student.Id","Problem.Name","Anon.Student.Id","Anon.Student.Id","KC..MATHia.","KC..MATHia.","KC..MATHia."),
      forv=500,bacv=500,
      allfeatures = c("lineafm","logafm","logsuc","logfail",
                      "linesuc","linefail","logitdec","propdec","recency","expdecafm","logsuc$", "logfail$"),
      traceCV=FALSE,
      currentfeatures = c("intercept", "intercept", "logsuc", "logfail","intercept", 
                          "logsuc$", "logfail$"))
#used for lasso
q3<-  buildLKTModel(data = val2, interc=TRUE,
      allcomponents = c("Anon.Student.Id", "KC..MATHia.","Problem.Name"),
      currentcomponents = c(),
      forv=500,bacv=500,
      allfeatures = c("lineafm","logafm","logsuc","logfail",
                      "linesuc","linefail","logitdec","propdec","recency","expdecafm","logsuc$", "logfail$"),
      traceCV=FALSE,
      currentfeatures = c())
```

#Bidirectional BestLR Assistments
```{r, echo=TRUE}

skill_builder_data <- read.csv("C:/Users/ppavl/Dropbox/Active projects/skill_builder_data_corrected_collapsed.csv")
skill_builder_data$Anon.Student.Id<-skill_builder_data$user_id

    skill_builder_data<-skill_builder_data[order(skill_builder_data$Anon.Student.Id, skill_builder_data$order_id),]
    skill_builder_data$CF..ansbin.<- skill_builder_data$correct
    
  subtot<-  aggregate(skill_builder_data$CF..ansbin.,by=list(skill_builder_data$Anon.Student.Id),FUN=length)
  subtot<- subtot[subtot$x<20,]
    skill_builder_data<-skill_builder_data[!(skill_builder_data$Anon.Student.Id %in% subtot$Group.1),]
students<-unique(skill_builder_data$Anon.Student.Id)
fold<-sample(1:5,length(students),replace=T)
students<-cbind(students,fold)
subsetstudents<-students[students[,2]==1,1]

    skill_builder_datasub<- skill_builder_data[(skill_builder_data$Anon.Student.Id %in% subsetstudents),]
    
q<-  buildLKTModel(data = setDT(skill_builder_datasub), interc=TRUE,
      allcomponents = c("Anon.Student.Id","skill_name","problem_id"),
      currentcomponents = c("Anon.Student.Id","problem_id","Anon.Student.Id","Anon.Student.Id","skill_name",
                            "skill_name","skill_name"),
      forv=2500,bacv=2250,
      allfeatures = c("lineafm","logafm","logsuc","logfail",
                      "linesuc","linefail","propdec"),
      traceCV=FALSE,
      currentfeatures = c("intercept", "intercept", "linesuc", "linefail","intercept", 
                          "logsuc$", "logfail$"),metric="BIC")
```



#Bidirectional BestLR features enhanced with full start BIC
```{r, echo=TRUE}

q<-  buildLKTModel(data = val, interc=TRUE,
      allcomponents = c("Anon.Student.Id", "KC..Default.","KC..Cluster.","CF..Correct.Answer."),
      currentcomponents = c("Anon.Student.Id","KC..Cluster.","KC..Cluster.","CF..Correct.Answer.","CF..Correct.Answer."),forv=500,bacv=500,
      allfeatures = c("lineafm","logafm","logsuc","logfail",
                      "linesuc","linefail","logitdec","propdec","recency","expdecafm","logsuc$", "logfail$"),traceCV=TRUE,maxitv=4,
      currentfeatures = c("intercept", "intercept",         "lineafm$", "intercept",         "lineafm$"),metric="BIC")

q2<-  buildLKTModel(data = val, interc=TRUE,
      allcomponents = c("Anon.Student.Id", "KC..Default.","KC..Cluster.","CF..Correct.Answer."),
      currentcomponents = c("Anon.Student.Id","KC..Default.","Anon.Student.Id","Anon.Student.Id","KC..Cluster.","KC..Cluster.",
                            "KC..Cluster.","CF..Correct.Answer.","CF..Correct.Answer.","CF..Correct.Answer."),
      forv=500,bacv=500,
      allfeatures = c("lineafm","logafm","logsuc","logfail",
                      "linesuc","linefail","logitdec","propdec","recency","expdecafm","logsuc$", "logfail$"),
      traceCV=TRUE,
     currentfeatures = c("intercept", "intercept", "logsuc", "logfail","intercept", "logsuc$",
                          "logfail$","intercept", "logsuc$", "logfail$"))
```


#Carvalho Data
```{r, echo=TRUE}
library(plyr)
#This function is for the model prediction


# so there is 500ms, RT, then 2000ms if wrong then 
mdatax<-function(data,pred){
  data$pred<-modelob$prediction
  mdat <- ddply(data, c("itemtype", "similarity","practice","Anon.Student.Id","studied"), summarise,
                mean = mean(pred))
  names(mdat)[names(mdat)=="mean"]<-"pred"
  mdata<-ddply(mdat, c("itemtype", "similarity","practice","studied"), summarise,
               N    = length(pred),
               mean = mean(pred),
               sd   = sd(pred),
               se   = sd / sqrt(N)
  )
  mdata$type<-"model"
  mdata<-mdata
}

emplot <- function(empiricaldata, modeldata,modelname){
  print(cor(modeldata$mean,empiricaldata$mean))
  plot <- ggplot(empiricaldata, aes(x=similarity, y=mean,fill = practice)) +
    geom_bar(position="dodge",stat="identity",color="black",alpha=0.4) +
    coord_cartesian(ylim = c(0,1), expand = TRUE) +
    geom_errorbar(data = empiricaldata,aes(ymax = mean + se, ymin= mean - se, width=0.2),position=position_dodge(width = 0.90)) +
    geom_point(data = modeldata, aes(x=similarity, y=mean,group = practice,colour=practice),position=position_dodge(width = 0.90),size=4) +
    geom_errorbar(data = modeldata, aes(ymax = mean + se, ymin= mean - se, width=0.2,colour=practice),position=position_dodge(width = 0.90)) +
    scale_colour_manual(values=c("#e66101","#b2abd2")) +
    labs(title=modelname,x="Category Structure",y="Probability of Correct Classification") + theme_bw() +  
    theme(legend.position="right",legend.title = element_blank(),panel.grid.major = element_blank(),panel.grid.minor=element_blank(),panel.background=element_blank()) +
    scale_fill_manual(values=c("#e66101","#b2abd2")) +
    theme(legend.position = c(0.1,0.9))
  plot + facet_grid(. ~ itemtype,as.table = T)
}
#
dat<-Paulodata

dat$Duration..sec.<-(dat$RT+1500+ifelse(dat$CF..ansbin.==0,2000,0))/1000
#This function is for the plot

cat2<-dat$Category
dat<-computeSpacingPredictors(dat,"Category")

dat<-computeSpacingPredictors(dat,"cat2")
dat<-computeSpacingPredictors(dat,"Anon.Student.Id")
dat<-computeSpacingPredictors(dat,"Problem.Name")
dat<-computeSpacingPredictors(dat,"similarity")

dat$spac<-ifelse(dat$Categorymeanspacing<1,0,log(dat$Categorymeanspacing+1))
dat$spaclin<-ifelse(dat$Categorymeanspacing<1,0,dat$Categorymeanspacing+1)

#This is for the real data
emdat <- ddply(dat, c("itemtype", "similarity","practice","Anon.Student.Id","studied"), summarise,
               mean = mean(CF..ansbin.)
)
names(emdat)[names(emdat)=="mean"]<-"empred"

emdata<-ddply(emdat, c("itemtype", "similarity","practice","studied"), summarise,
              N    = length(empred),
              mean = mean(empred),
              sd   = sd(empred),
              se   = sd / sqrt(N)
)
emdata$type<-"emmodel"
emdata1<-emdata[17:24,]

dat$dum<-ifelse(dat$spac==0,1,0)




modelob <- LKT(#connectors = c("+","*","+","+","+","+","+"),
  data = dat, interc=TRUE,verbose=T,
  components = c("Category","Category","Problem.Name","Problem.Name","Anon.Student.Id"),
  #covariates=c("similarity",NA,"similarity",NA,NA,NA),
  features = c("recency","logitdec","recency","logitdec","logitdec"),fixedpars=c(0.5833941,0.9152019,0.3662952,0.7435518,0.9456435)
)

dat$pred1<-modelob$prediction
mdata1<-mdatax(dat,pred1)
mdata11<-mdata1[17:24,]
cor(mdata1$mean,emdata$mean)
emplot(emdata1,mdata11,"PFA-Categorization")  #the plot of posttest
emplot(emdata,mdata1,"PFA-Categorization")      #the plot of all the sessions



modelob <- LKT(#connectors = c("+","*","+","+","+","+","+"),
  data = dat, interc=TRUE,verbose=T,
  components = c("Category","Category","Problem.Name","Problem.Name","Anon.Student.Id","similarity"),
  covariates=c("similarity",NA,"similarity",NA,NA,NA),
  features = c("recency","logitdec","recency","logitdec","logitdec","intercept"),fixedpars=c(0.5833941,0.9152019,0.3662952,0.7435518,0.9456435)
)

dat$pred1<-modelob$prediction
mdata1<-mdatax(dat,pred1)
mdata11<-mdata1[17:24,]
cor(mdata1$mean,emdata$mean)
emplot(emdata1,mdata11,"PFA-Categorization")  #the plot of posttest
emplot(emdata,mdata1,"PFA-Categorization")      #the plot of all the sessions

modelob <- LKT(#connectors = c("+","*","+","+","+","+","+"),
  data = dat, interc=TRUE,verbose=T,
  components = c("Category","Category","Problem.Name","Problem.Name","Anon.Student.Id","similarity"),
  covariates=c("similarity*practice",NA,"similarity*practice",NA,NA,NA),
  features = c("recency","logitdec","recency","logitdec","logitdec","intercept"),fixedpars=c(0.5833941,0.9152019,0.3662952,0.7435518,0.9456435)
)

dat$pred1<-modelob$prediction
mdata1<-mdatax(dat,pred1)
mdata11<-mdata1[17:24,]
cor(mdata1$mean,emdata$mean)
emplot(emdata1,mdata11,"PFA-Categorization")  #the plot of posttest
emplot(emdata,mdata1,"PFA-Categorization")      #the plot of all the sessions


modelob <- LKT(#connectors = c("+","*","+","+","+","+","+"),
  data = dat, interc=TRUE,verbose=T,
  components = c("Category","Category","Problem.Name","Problem.Name","Anon.Student.Id","similarity","dum"),
  covariates=c("similarity*spac",NA,"similarity*spac",NA,NA,NA,NA),
  features = c("recency","logitdec","recency","logitdec","logitdec","intercept","intercept"),fixedpars=c(0.5833941,0.9152019,0.3662952,0.7435518,0.9456435)
)

dat$pred1<-modelob$prediction
mdata1<-mdatax(dat,pred1)
mdata11<-mdata1[17:24,]
cor(mdata1$mean,emdata$mean)
emplot(emdata1,mdata11,"PFA-Categorization")  #the plot of posttest
emplot(emdata,mdata1,"PFA-Categorization")      #the plot of all the sessions

```





```{r, echo=TRUE}



q<-  buildLKTModel(data = dat, interc=TRUE,
      allcomponents = c("Category"),
      currentcomponents = c("Category","Category","Problem.Name","Problem.Name","Anon.Student.Id"),forv=.001,bacv=.001,
      allfeatures = c("ppe"),currentfixedpars=c(0.4617277, 0.922732, 0.3778021, 0.7284311, 0.8526322),      currentfeatures = c("recency","logitdec","recency","logitdec","logitdec"),traceCV=FALSE,verbose=F,maxitv=7,metric="R2",backward = F)

modelob<-q[[2]]
dat$pred1<-modelob$prediction
mdata1<-mdatax(dat,pred1)
mdata11<-mdata1[17:24,]
cor(mdata1$mean,emdata$mean)
emplot(emdata1,mdata11,"PFA-Categorization")  #the plot of posttest
emplot(emdata,mdata1,"PFA-Categorization")      #the plot of all the sessions
q[[2]]$coefs
```
